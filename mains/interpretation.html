<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Interpretation (SHAP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap / Icons / Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Your styles (optional) -->
  <link rel="stylesheet" href="../style.css" />
  <link rel="stylesheet" href="../interpretation.css" />
  <link rel="icon" href="../assets/logo.png" type="image/png" />

  <!-- Select2 CSS (searchable dropdown) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

  <style>
    body {
      font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
    }

    /* Slider label with live value */
    .slider-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .slider-value {
      font-weight: 600;
      color: #0d3b66;
      margin-left: 8px;
    }

    .leaflet-map {
      min-height: 520px;
      width: 100%;
    }

    .leaflet-control .legend-card {
      background: #fff;
      border-radius: .5rem;
      box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, .1);
      padding: .75rem;
      font-size: .9rem;
    }

    .legend-swatch {
      display: inline-block;
      width: 14px;
      height: 14px;
      margin-right: 6px;
      border: 1px solid rgba(0, 0, 0, .15);
      vertical-align: middle;
    }

    /* Select2 look */
    .select2-container .select2-selection--single {
      height: 38px;
      border-radius: .375rem;
      border: 1px solid #ddd;
      font-size: 14px;
    }

    .select2-container .select2-selection__arrow {
      height: 100%;
    }

    /* Optional brand helpers*/
    .bg-brand {
      background: #0d3b66;
    }

    .text-brand {
      color: #0d3b66;
    }

    .btn-brand2 {
      background: #f4a261;
      color: #fff;
      border: none;
    }

    .btn-brand2:hover {
      background: #e98b3f;
      color: #fff;
    }
  </style>
</head>

<body class="d-flex flex-column flex-md-row bg-light min-vh-100">
  <!-- Sidebar -->
  <div id="sidebar-container" class="flex-shrink-0"></div>

  <!-- Main Content -->
  <div class="flex-grow-1 px-3 px-md-4 py-3">
    <div class="bg-brand p-2 rounded-2 text-white fs-6 mb-4">Invasion Risk Prediction</div>

    <div class="row g-4">
      <!-- Input Panel -->
      <div class="col-12 col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5 class="mb-4">Risk Prediction Inputs</h5>
            <form id="predict-form">
              <!-- Temperature -->
              <div class="slider-head">
                <label for="temperature" class="mb-1 d-flex align-items-center">Temperature (°C)
                <i class="bi bi-question-circle ms-2" 
                  style= "color:#0C3970;"
                  data-bs-toggle="tooltip"
                  data-bs-placement="right"
                  title="Temperature affects fish by increasing their metabolic rate, which raises their oxygen and food demands while often forcing them to move to areas with more suitable conditions for feeding and survival."></i>
                </label>
                <span id="temperature_value" class="slider-value">0</span>
              </div>
              <div class="bg-brand rounded-4 p-2 px-3 mb-3">
                <input type="range" id="temperature" class="form-range" min="0" max="50" step="0.1" value="0">
              </div>

              <!-- Water pH -->
              <div class="slider-head">
                <label for="water_ph" class="mb-1">Water pH
                <i class="bi bi-question-circle" 
                  style= "color:#0C3970;"
                  data-bs-toggle="tooltip"
                  data-bs-placement="right"
                  title="pH levels affect fish by influencing their growth, reproduction, and immune function, as values outside their optimal range cause stress, increase disease risk, and disrupt essential processes like nitrification and water quality balance."></i>
                </label>
                <span id="water_ph_value" class="slider-value">0</span>
              </div>
              <div class="bg-brand rounded-4 p-2 px-3 mb-3">
                <input type="range" id="water_ph" class="form-range" min="0" max="14" step="0.1" value="0">
              </div>

              <!-- Salinity -->
              <div class="slider-head">
                <label for="salinity" class="mb-1">Salinity (ppt)
                <i class="bi bi-question-circle" 
                  style= "color:#0C3970;"
                  data-bs-placement="right"
                  title="Salinity affects fish by impacting their physiology, behavior, growth, and reproduction, primarily through the process of osmoregulation, which is the regulation of the body's salt and water balance."></i>
                </label>
                <span id="salinity_value" class="slider-value">0</span>
              </div>
              <div class="bg-brand rounded-4 p-2 px-3 mb-3">
                <input type="range" id="salinity" class="form-range" min="0" max="40" step="0.1" value="0">
              </div>

              <!-- Dissolved Oxygen -->
              <div class="slider-head">
                <label for="dissolved_oxygen" class="mb-1">Dissolved Oxygen (mg/L)
                <i class="bi bi-question-circle" 
                  style= "color:#0C3970;"
                  data-bs-toggle="tooltip"
                  data-bs-placement="right"
                  title="Dissolved oxygen (DO) is vital for fish survival, as low DO levels reduce their ability to breathe and can lead to stress or death, while adequate oxygen supports healthy growth and overall aquatic ecosystem balance."></i>
                </label>
                <span id="dissolved_oxygen_value" class="slider-value">0</span>
              </div>
              <div class="bg-brand rounded-4 p-2 px-3 mb-3">
                <input type="range" id="dissolved_oxygen" class="form-range" min="0" max="20" step="0.1" value="0">
              </div>

              <!-- BOD -->
              <div class="slider-head">
                <label for="bod" class="mb-1">Biochemical Oxygen Demand (BOD) (mg/L)
                <i class="bi bi-question-circle" 
                  style= "color:#0C3970;"
                  data-bs-toggle="tooltip"
                  data-bs-placement="right"
                  title="Biochemical Oxygen Demand (BOD) affects fish by reducing the amount of dissolved oxygen in the water, and as BOD increases, oxygen depletion intensifies, leading to stress, suffocation, and death among aquatic organisms while promoting harmful processes like eutrophication."></i>
                </label>
                <span id="bod_value" class="slider-value">0</span>
              </div>
              <div class="bg-brand rounded-4 p-2 px-3 mb-3">
                <input type="range" id="bod" class="form-range" min="0" max="140" step="0.1" value="0">
              </div>

              <!-- Turbidity -->
              <div class="slider-head">
                <label for="turbidity" class="mb-1">Turbidity (NTU)
                <i class="bi bi-question-circle" 
                  style= "color:#0C3970;"
                  data-bs-toggle="tooltip"
                  data-bs-placement="right"
                  title="Turbidity affects fish by reducing water clarity, clogging gills, lowering oxygen levels, and hindering feeding and predator avoidance, ultimately impacting their growth, health, and survival."></i>
                </label>
                <span id="turbidity_value" class="slider-value">0</span>
              </div>
              <div class="bg-brand rounded-4 p-2 px-3 mb-3">
                <input type="range" id="turbidity" class="form-range" min="0" max="250" step="1" value="0">
              </div>

              <!-- Species -->
              <label for="specie">Species</label>
              <select id="specie" class="form-select rounded-4 mb-3"></select>

              <!-- Dynamic description panel -->
              <div id="species-note" class="bg-brand text-white p-2 rounded-4 mb-3 mt-3" style="min-height: 54px;">
                <em class="opacity-75">Select a species to see its description...</em>
              </div>

              <div class="d-flex justify-content-center gap-2 mt-3">
                <button type="submit" class="btn btn-brand2">Run Prediction</button>
                <button type="button" class="btn btn-outline-secondary" onclick="SharedState.confirmAndReset()"
                  title="Clear all inputs and start fresh">
                  <i class="bi bi-arrow-clockwise me-1"></i> New Prediction
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Right Panel -->
      <div class="col-12 col-md-8">
        <div class="navbar-custom border-bottom bg-brand rounded-3 text-white mb-3 overflow-auto">
          <ul class="nav justify-content-center flex-wrap">
            <li class="nav-item"><a class="nav-link" href="Overview.html">Overview</a></li>
            <li class="nav-item"><a class="nav-link" href="predict.html">Invasion Risk Map</a></li>
            <li class="nav-item"><a class="nav-link active" href="interpretation.html">Interpretation (SHAP)</a></li>
            <li class="nav-item"><a class="nav-link" href="risk_scores.html">Risk Scores</a></li>
          </ul>
        </div>

        <div class="card shadow-sm">
          <div class="card-body">
            <h4 class="text-brand text-center mb-4">SHAP Analysis</h4>
            <div id="feature-importance-container">
              <p class="text-muted text-center">
                Select a species and input parameters, then click "Run Prediction" to see feature importance analysis.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- This is where results from the backend will appear -->
      <!--<div id="feature-importance-container" class="mt-4"></div>-->

      <!-- Wait Modal (shown on submit) -->
      <div class="modal fade" id="predictWaitModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-body d-flex align-items-center">
              <div class="spinner-border me-3" role="status" aria-hidden="true"></div>
              <div>
                <h6 class="mb-0">Predicting fish invasiveness…</h6>
                <small class="text-muted">Please wait</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- JS: jQuery / Bootstrap (for modal) / Select2 / Papa Parse -->
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
      <script src="shared_state.js"></script>

      <script>
        $(function () {
          // Tooltip activation script
          const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
          tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
          });
          
          // Sidebar (optional)
          try { $("#sidebar-container").load("../includes/sidebar.html"); }
          catch (err) { console.error("Sidebar loading failed:", err); }

          const API_BASE_URL = "http://localhost:5000/api";

          // Live slider values
          ["temperature", "water_ph", "salinity", "dissolved_oxygen", "bod", "turbidity"].forEach(id => {
            const slider = document.getElementById(id);
            const out = document.getElementById(id + "_value");
            if (!slider || !out) return;
            const update = () => { out.textContent = slider.value; };
            update();
            slider.addEventListener("input", update);
          });

          // Wait modal and form submission
          const waitModal = new bootstrap.Modal(document.getElementById('predictWaitModal'), {
            backdrop: 'static', keyboard: false
          });
          document.getElementById("predict-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            waitModal.show();
            try {
              await loadFeatureImportance();
            } finally {
              setTimeout(() => waitModal.hide(), 500);
            }
          });

          // ======================
          // Species CSV integration
          // ======================
          const CSV_URL = "../assets/fish_description.csv"; // adjust if needed
          const $specie = $("#specie");
          const noteEl = document.getElementById("species-note");

          function showError(msg) {
            console.error(msg);
            noteEl.innerHTML = `<div class="alert alert-warning mb-0 py-2">${msg}</div>`;
          }

          function renderDescription(d) {
            if (!d) {
              noteEl.innerHTML = `<em class="opacity-75">Select a species to see its description...</em>`;
              return;
            }
            const common = d.commonName ? `<strong>${d.commonName}</strong>` : `<strong>Unknown common name</strong>`;
            const sci = d.sciName ? `<em>${d.sciName}</em>` : '';
            const desc = d.description || 'No description provided.';
            noteEl.innerHTML = `
          <div>${common} ${sci ? `(${sci})` : ''}</div>
          <div class="mt-1">${desc}</div>
        `;
          }

          function hydrateWithFallback() {
            $specie.empty().append(`<option></option>`);

            fallback.forEach((it, idx) => {
              $specie.append(
                $(`<option></option>`)
                  .val(`fallback_${idx}`)
                  .text(`${it.commonName} (${it.sciName})`)
                  .attr("data-common", it.commonName)
                  .attr("data-sci", it.sciName)
                  .attr("data-desc", it.description)
              );
            });

            if ($specie.hasClass("select2-hidden-accessible")) {
              $specie.select2("destroy");
            }
            $specie.select2({ placeholder: "Select a species", allowClear: true });

            $specie.off("change").on("change", function () {
              const opt = this.selectedOptions && this.selectedOptions[0];
              if (!opt) return renderDescription(null);
              const d = {
                commonName: opt.getAttribute("data-common"),
                sciName: opt.getAttribute("data-sci"),
                description: opt.getAttribute("data-desc")
              };
              renderDescription(d);
            });

            renderDescription(null);
          }

          Papa.parse(CSV_URL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function (results) {
              console.log("Papa complete:", results);

              if (!results || !results.data) {
                showError("CSV parsed but no data returned. Using fallback.");
                return hydrateWithFallback();
              }

              const sample = results.data[0] || {};
              const hasSpecies = Object.prototype.hasOwnProperty.call(sample, "Species");
              const hasCommon = Object.prototype.hasOwnProperty.call(sample, "CommonName");
              const hasDesc = Object.prototype.hasOwnProperty.call(sample, "Description");
              if (!hasSpecies || !hasCommon || !hasDesc) {
                showError("CSV must have headers: Species, CommonName, Description. Using fallback.");
                return hydrateWithFallback();
              }

              const items = results.data
                .map((r, idx) => ({
                  sciName: (r["Species"] || "").toString().trim(),
                  commonName: (r["CommonName"] || "").toString().trim(),
                  description: (r["Description"] || "").toString().trim(),
                  idx
                }))
                .filter(row => row.sciName || row.commonName);

              if (!items.length) {
                showError("CSV loaded but contains no usable rows. Using fallback.");
                return hydrateWithFallback();
              }

              // Populate <option>s BEFORE Select2 init
              $specie.empty();
              $specie.append(`<option></option>`);
              items.forEach((it) => {
                const label = it.commonName ? `${it.commonName} (${it.sciName})` : it.sciName;
                $specie.append(
                  $(`<option></option>`)
                    .val(`row_${it.idx}`)
                    .text(label)
                    .attr("data-common", it.commonName)
                    .attr("data-sci", it.sciName)
                    .attr("data-desc", it.description)
                );
              });

              // Initialize Select2
              $specie.select2({
                placeholder: "Select a species",
                allowClear: true,
                templateResult: function (option) {
                  if (!option.id) return option.text;
                  const $el = $(option.element);
                  const common = $el.data("common") || "";
                  const sci = $el.data("sci") || "";
                  return $(`
                <div>
                  <div class="fw-semibold">${common || "(No common name)"}</div>
                  <div class="text-muted small"><i>${sci}</i></div>
                </div>
              `);
                },
                templateSelection: function (option) {
                  if (!option.id) return option.text || "";
                  const $el = $(option.element);
                  const common = $el.data("common") || "(No common name)";
                  const sci = $el.data("sci") || "";
                  return `${common}${sci ? ` (${sci})` : ""}`;
                }
              });

              // Change handler -> description
              $specie.on("change", function () {
                const opt = this.selectedOptions && this.selectedOptions[0];
                if (!opt) return renderDescription(null);
                const d = {
                  commonName: opt.getAttribute("data-common"),
                  sciName: opt.getAttribute("data-sci"),
                  description: opt.getAttribute("data-desc")
                };
                renderDescription(d);
              });

              // Restore saved species selection
              SharedState.restoreSpeciesSelection($specie);

              // Auto-load previous prediction if available
              if (SharedState.hasPredictionData()) {
                console.log('Previous prediction data found, auto-loading...');
                setTimeout(() => loadFeatureImportance(), 500);
              }
            },
            error: function (err) {
              console.error("Papa error:", err);
              showError("Failed to load CSV. Using fallback data.");
              hydrateWithFallback();
            }
          });

          // Feature importance fetch and display
          async function loadFeatureImportance() {
            const container = document.getElementById('feature-importance-container');
            const specieSelect = document.getElementById('specie');
            const selectedOption = specieSelect.options[specieSelect.selectedIndex];
            const speciesName = selectedOption ? selectedOption.getAttribute('data-sci') : '';

            if (!speciesName) {
              container.innerHTML = '<div class="alert alert-warning">Please select a species and run prediction first!</div>';
              return;
            }

            container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Analyzing feature importance for this prediction...</p></div>';

            // Get input values
            const temperature = parseFloat(document.getElementById('temperature').value);
            const ph = parseFloat(document.getElementById('water_ph').value);
            const salinity = parseFloat(document.getElementById('salinity').value);
            const dissolved_oxygen = parseFloat(document.getElementById('dissolved_oxygen').value);
            const bod = parseFloat(document.getElementById('bod').value);
            const turbidity = parseFloat(document.getElementById('turbidity').value);

            // Calculate derived fields that match backend expectations
            const wb_temp_min = temperature - 2;
            const wb_temp_max = temperature + 2;
            const wb_ph_min = ph - 0.5;
            const wb_ph_max = ph + 0.5;

            const payload = {
              species: speciesName,
              // Basic inputs
              temperature: temperature,
              ph: ph,
              salinity: salinity,
              dissolved_oxygen: dissolved_oxygen,
              bod: bod,
              turbidity: turbidity,
              // Water body parameters
              wb_temp_min: wb_temp_min,
              wb_temp_max: wb_temp_max,
              wb_temp_range: wb_temp_max - wb_temp_min,
              wb_ph_min: wb_ph_min,
              wb_ph_max: wb_ph_max,
              wb_ph_range: wb_ph_max - wb_ph_min,
              wb_salinity_min: Math.max(0, salinity - 1),
              wb_salinity_max: salinity + 1,
              wb_do_min: Math.max(0, dissolved_oxygen - 1),
              wb_do_max: dissolved_oxygen + 1,
              wb_bod_min: Math.max(0, bod - 1),
              wb_bod_max: bod + 1,
              wb_turbidity_min: Math.max(0, turbidity - 10),
              wb_turbidity_max: turbidity + 10,
              // Preference and derived fields
              temp_pref_min: temperature - 5,
              temp_pref_max: temperature + 5,
              temp_pref_range: 10, // temp_pref_max - temp_pref_min
              temp_in_pref_range: 1, // Assuming within preference range
              fish_ph_pref: ph,
              ph_difference: 0 // Assuming optimal pH match
            };

            try {
              const response = await fetch(`${API_BASE_URL}/interpretation/feature-importance`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              const data = await response.json();

              if (data.success) {
                displayFeatureImportance(data.data);
              } else {
                container.innerHTML = `<div class="alert alert-danger">Failed to load feature importance: ${data.error}</div>`;
              }
            } catch (error) {
              container.innerHTML = '<div class="alert alert-danger">Failed to connect to backend API. Please ensure the server is running.</div>';
            }
          }



          function displayFeatureImportance(data) {
            const container = document.getElementById('feature-importance-container');
            let html = `
            <div class="mb-4">
              <h5 class="mb-3">Aggregated Feature Importance by Environmental Parameter</h5>
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th style="width: 35%;">Parameter</th>
                      <th style="width: 65%;">Percentage</th>
                    </tr>
                  </thead>
                  <tbody>
          `;

            data.aggregated_importance.forEach(param => {
              const barWidth = param.percentage;
              html += `
              <tr>
                <td><strong>${param.parameter}</strong></td>
                <td>
                  <div class="d-flex align-items-center gap-2">
                    <div class="progress flex-grow-1" style="height: 40px; margin-right: 4px;">
                      <div class="progress-bar" role="progressbar" 
                          style="width: ${barWidth}%; background-color: #0d3b66;" 
                          aria-valuenow="${barWidth}" aria-valuemin="0" aria-valuemax="100">
                      </div>
                    </div>
                    <span class="text-nowrap" style="min-width: 50px;">${param.percentage.toFixed(1)}%</span>
                  </div>
                </td>
              </tr>
            `;
            });

            html += `
                  </tbody>
                </table>
              </div>
            </div>
          `;

            container.innerHTML = html;
          }

        });
      </script>
</body>

</html>