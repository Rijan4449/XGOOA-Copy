<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Risk Scores</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="../style.css" />
  <link rel="stylesheet" href="../risk_score.css" />
  <link rel="icon" href="../assets/logo.png" type="image/png" />

  <!-- Select2 CSS (searchable dropdown) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

  <style>
    body {
      font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
    }

    /* Slider label with live value */
    .slider-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .slider-value {
      font-weight: 600;
      color: #0d3b66;
      margin-left: 8px;
    }

    .leaflet-map {
      min-height: 520px;
      width: 100%;
    }

    .leaflet-control .legend-card {
      background: #fff;
      border-radius: .5rem;
      box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, .1);
      padding: .75rem;
      font-size: .9rem;
    }

    .legend-swatch {
      display: inline-block;
      width: 14px;
      height: 14px;
      margin-right: 6px;
      border: 1px solid rgba(0, 0, 0, .15);
      vertical-align: middle;
    }

    /* Customizing the Select2 dropdown to match your CSS */
    .select2-container .select2-selection--single {
      height: 38px;
      /* Match the input height */
      border-radius: .375rem;
      /* Same rounded corners as your input */
      border: 1px solid #ddd;
      /* Match the border style */
      font-size: 14px;
      /* Consistent font size */
    }

    .select2-container .select2-selection__arrow {
      height: 100%;
      /* Adjust arrow size */
    }
  </style>
</head>

<body class="d-flex flex-column flex-md-row bg-light min-vh-100">
  <!-- Sidebar -->
  <div id="sidebar-container" class="flex-shrink-0"></div>

  <!-- Main Content -->
  <div class="flex-grow-1 px-3 px-md-4 py-3">
    <div class="bg-brand p-2 rounded-2 text-white fs-6 mb-4">Invasion Risk Prediction</div>

    <div class="row g-4">
      <!-- Input Panel -->
      <div class="col-12 col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5 class="mb-4">Risk Prediction Inputs</h5>
            <form id="predict-form">
              <!-- Temperature -->
              <div class="slider-head">
                <label for="temperature" class="mb-1 d-flex align-items-center">Temperature (°C)
                  <i class="bi bi-question-circle ms-2" style="color:#0C3970;" data-bs-toggle="tooltip"
                    data-bs-placement="right"
                    title="Temperature affects fish by increasing their metabolic rate, which raises their oxygen and food demands while often forcing them to move to areas with more suitable conditions for feeding and survival."></i>
                </label>
                <span id="temperature_value" class="slider-value">0</span>
              </div>
              <div class="bg-brand rounded-4 p-2 px-3 mb-3">
                <input type="range" id="temperature" class="form-range" min="0" max="50" step="0.1" value="0">
              </div>

              <!-- Water pH -->
              <div class="slider-head">
                <label for="water_ph" class="mb-1">Water pH
                  <i class="bi bi-question-circle" style="color:#0C3970;" data-bs-toggle="tooltip"
                    data-bs-placement="right"
                    title="pH levels affect fish by influencing their growth, reproduction, and immune function, as values outside their optimal range cause stress, increase disease risk, and disrupt essential processes like nitrification and water quality balance."></i>
                </label>
                <span id="water_ph_value" class="slider-value">0</span>
              </div>
              <div class="bg-brand rounded-4 p-2 px-3 mb-3">
                <input type="range" id="water_ph" class="form-range" min="0" max="14" step="0.1" value="0">
              </div>

              <!-- Salinity -->
              <div class="slider-head">
                <label for="salinity" class="mb-1">Salinity (ppt)
                  <i class="bi bi-question-circle" style="color:#0C3970;" data-bs-placement="right"
                    title="Salinity affects fish by impacting their physiology, behavior, growth, and reproduction, primarily through the process of osmoregulation, which is the regulation of the body's salt and water balance."></i>
                </label>
                <span id="salinity_value" class="slider-value">0</span>
              </div>
              <div class="bg-brand rounded-4 p-2 px-3 mb-3">
                <input type="range" id="salinity" class="form-range" min="0" max="40" step="0.1" value="0">
              </div>

              <!-- Dissolved Oxygen -->
              <div class="slider-head">
                <label for="dissolved_oxygen" class="mb-1">Dissolved Oxygen (mg/L)
                  <i class="bi bi-question-circle" style="color:#0C3970;" data-bs-toggle="tooltip"
                    data-bs-placement="right"
                    title="Dissolved oxygen (DO) is vital for fish survival, as low DO levels reduce their ability to breathe and can lead to stress or death, while adequate oxygen supports healthy growth and overall aquatic ecosystem balance."></i>
                </label>
                <span id="dissolved_oxygen_value" class="slider-value">0</span>
              </div>
              <div class="bg-brand rounded-4 p-2 px-3 mb-3">
                <input type="range" id="dissolved_oxygen" class="form-range" min="0" max="20" step="0.1" value="0">
              </div>

              <!-- BOD -->
              <div class="slider-head">
                <label for="bod" class="mb-1">Biochemical Oxygen Demand (BOD) (mg/L)
                  <i class="bi bi-question-circle" style="color:#0C3970;" data-bs-toggle="tooltip"
                    data-bs-placement="right"
                    title="Biochemical Oxygen Demand (BOD) affects fish by reducing the amount of dissolved oxygen in the water, and as BOD increases, oxygen depletion intensifies, leading to stress, suffocation, and death among aquatic organisms while promoting harmful processes like eutrophication."></i>
                </label>
                <span id="bod_value" class="slider-value">0</span>
              </div>
              <div class="bg-brand rounded-4 p-2 px-3 mb-3">
                <input type="range" id="bod" class="form-range" min="0" max="140" step="0.1" value="0">
              </div>

              <!-- Turbidity -->
              <div class="slider-head">
                <label for="turbidity" class="mb-1">Turbidity (NTU)
                  <i class="bi bi-question-circle" style="color:#0C3970;" data-bs-toggle="tooltip"
                    data-bs-placement="right"
                    title="Turbidity affects fish by reducing water clarity, clogging gills, lowering oxygen levels, and hindering feeding and predator avoidance, ultimately impacting their growth, health, and survival."></i>
                </label>
                <span id="turbidity_value" class="slider-value">0</span>
              </div>
              <div class="bg-brand rounded-4 p-2 px-3 mb-3">
                <input type="range" id="turbidity" class="form-range" min="0" max="250" step="1" value="0">
              </div>

              <!-- Species -->
              <label for="specie">Species</label>
              <select id="specie" class="form-select rounded-4 mb-3"></select>

              <!-- Dynamic description panel -->
              <div id="species-note" class="bg-brand text-white p-2 rounded-4 mb-3 mt-3" style="min-height: 54px;">
                <em class="opacity-75">Select a species to see its description...</em>
              </div>

              <div class="d-flex justify-content-center gap-2 mt-3">
                <button type="submit" class="btn btn-brand2">Run Prediction</button>
                <button type="button" class="btn btn-outline-secondary" onclick="SharedState.confirmAndReset()"
                  title="Clear all inputs and start fresh">
                  <i class="bi bi-arrow-clockwise me-1"></i> New Prediction
                </button>
              </div>
            </form>
            <!-- Model Choice -->
            <label for="model_choice" class="mb-1 mt-3">Model to Use</label>
            <select id="model_choice" class="form-select rounded-4 mb-3">
              <option value="xgooa" selected>Proposed Model (XGOOA)</option>
              <option value="xgboost">XGBoost</option>
              <option value="mooa">Osprey Optimization Algorithm (MOOA)</option>
            </select>
            <small class="text-muted d-block mb-4">
              Choose which model to run for the prediction.
            </small>
          </div>
        </div>
      </div>

      <!-- Right Panel -->
      <div class="col-12 col-md-8">
        <div class="navbar-custom border-bottom bg-brand rounded-3 text-white mb-3 overflow-auto">
          <ul class="nav justify-content-center flex-wrap">
            <li class="nav-item"><a class="nav-link" href="Overview.html">Overview</a></li>
            <li class="nav-item"><a class="nav-link" href="predict.html">Invasion Risk Map</a></li>
            <li class="nav-item"><a class="nav-link" href="interpretation.html">Interpretation (SHAP)</a></li>
            <li class="nav-item"><a class="nav-link active" href="risk_scores.html">Risk Scores</a></li>
          </ul>
        </div>

        <div class="card shadow-sm right-card">
          <div class="card-body d-flex flex-column">
            <div class="table-wrapper">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Lake</th>
                    <th>Region</th>
                    <th>Invasion Risk Score</th>
                    <th>Presence</th>
                  </tr>
                </thead>
                <!-- removed hardcoded rows and added DB placeholder -->
                <tbody id="risk-score-table-body">
                  <tr>
                    <td colspan="4" class="text-center text-muted py-3">
                      Loading data from database...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Wait Modal (shown on submit) -->
  <div class="modal fade" id="predictWaitModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body d-flex align-items-center">
          <div class="spinner-border me-3" role="status" aria-hidden="true"></div>
          <div>
            <h6 class="mb-0">Predicting fish invasiveness…</h6>
            <small class="text-muted">Please wait</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS: jQuery / Bootstrap (for modal) / Select2 / Papa Parse -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="shared_state.js"></script>

  <script>
    $(function () {
      // Tooltip activation script
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
      });

      // Sidebar (optional)
      try { $("#sidebar-container").load("../includes/sidebar.html"); }
      catch (err) { console.error("Sidebar loading failed:", err); }

      // Live slider values
      ["temperature", "water_ph", "salinity", "dissolved_oxygen", "bod", "turbidity"].forEach(id => {
        const slider = document.getElementById(id);
        const out = document.getElementById(id + "_value");
        if (!slider || !out) return;
        const update = () => { out.textContent = slider.value; };
        update();
        slider.addEventListener("input", update);
      });

      // Wait modal and form submission
      const waitModal = new bootstrap.Modal(document.getElementById('predictWaitModal'), {
        backdrop: 'static', keyboard: false
      });
      document.getElementById("predict-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        waitModal.show();
        try {
          await loadRiskScores();
        } finally {
          setTimeout(() => waitModal.hide(), 500);
        }
      });

      // ======================
      // Species CSV integration
      // ======================
      const CSV_URL = "../assets/fish_description.csv"; // adjust if needed
      const $specie = $("#specie");
      const noteEl = document.getElementById("species-note");

      function showError(msg) {
        console.error(msg);
        noteEl.innerHTML = `<div class="alert alert-warning mb-0 py-2">${msg}</div>`;
      }

      function renderDescription(d) {
        if (!d) {
          noteEl.innerHTML = `<em class="opacity-75">Select a species to see its description...</em>`;
          return;
        }
        const common = d.commonName ? `<strong>${d.commonName}</strong>` : `<strong>Unknown common name</strong>`;
        const sci = d.sciName ? `<em>${d.sciName}</em>` : '';
        const desc = d.description || 'No description provided.';
        noteEl.innerHTML = `
          <div>${common} ${sci ? `(${sci})` : ''}</div>
          <div class="mt-1">${desc}</div>
        `;
      }

      function hydrateWithFallback() {
        // simple fallback list in case CSV fails
        const fallback = [
          { commonName: "Clown Knife Fish", sciName: "Chitala ornata", description: "Adaptable, predatory; potential risk to native and economic species." },
          { commonName: "Tilapia", sciName: "Oreochromis niloticus", description: "Common farmed species; can become invasive in some water bodies." }
        ];

        $specie.empty().append(`<option></option>`);

        fallback.forEach((it, idx) => {
          $specie.append(
            $(`<option></option>`)
              .val(`fallback_${idx}`)
              .text(`${it.commonName} (${it.sciName})`)
              .attr("data-common", it.commonName)
              .attr("data-sci", it.sciName)
              .attr("data-desc", it.description)
          );
        });

        if ($specie.hasClass("select2-hidden-accessible")) {
          $specie.select2("destroy");
        }
        $specie.select2({ placeholder: "Select a species", allowClear: true });

        $specie.off("change").on("change", function () {
          const opt = this.selectedOptions && this.selectedOptions[0];
          if (!opt) return renderDescription(null);
          const d = {
            commonName: opt.getAttribute("data-common"),
            sciName: opt.getAttribute("data-sci"),
            description: opt.getAttribute("data-desc")
          };
          renderDescription(d);
        });

        renderDescription(null);
      }

      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          console.log("Papa complete:", results);

          if (!results || !results.data) {
            showError("CSV parsed but no data returned. Using fallback.");
            return hydrateWithFallback();
          }

          const sample = results.data[0] || {};
          const hasSpecies = Object.prototype.hasOwnProperty.call(sample, "Species");
          const hasCommon = Object.prototype.hasOwnProperty.call(sample, "CommonName");
          const hasDesc = Object.prototype.hasOwnProperty.call(sample, "Description");
          if (!hasSpecies || !hasCommon || !hasDesc) {
            showError("CSV must have headers: Species, CommonName, Description. Using fallback.");
            return hydrateWithFallback();
          }

          const items = results.data
            .map((r, idx) => ({
              sciName: (r["Species"] || "").toString().trim(),
              commonName: (r["CommonName"] || "").toString().trim(),
              description: (r["Description"] || "").toString().trim(),
              idx
            }))
            .filter(row => row.sciName || row.commonName);

          if (!items.length) {
            showError("CSV loaded but contains no usable rows. Using fallback.");
            return hydrateWithFallback();
          }

          // Populate <option>s BEFORE Select2 init
          $specie.empty();
          $specie.append(`<option></option>`);
          items.forEach((it) => {
            const label = it.commonName ? `${it.commonName} (${it.sciName})` : it.sciName;
            $specie.append(
              $(`<option></option>`)
                .val(`row_${it.idx}`)
                .text(label)
                .attr("data-common", it.commonName)
                .attr("data-sci", it.sciName)
                .attr("data-desc", it.description)
            );
          });

          // Initialize Select2 
          $specie.select2({
            placeholder: "Select a species",
            allowClear: true,
            width: '100%',
            templateResult: function (option) {
              if (!option.id) return option.text;
              const $el = $(option.element);
              const common = $el.data("common") || "";
              const sci = $el.data("sci") || "";
              return $(`
                <div>
                  <div class="fw-semibold">${common || "(No common name)"}</div>
                  <div class="text-muted small"><i>${sci}</i></div>
                </div>
              `);
            },
            templateSelection: function (option) {
              if (!option.id) return option.text || "";
              const $el = $(option.element);
              const common = $el.data("common") || "(No common name)";
              const sci = $el.data("sci") || "";
              return `${common}${sci ? ` (${sci})` : ""}`;
            }
          });

          // Change handler -> description
          $specie.on("change", function () {
            const opt = this.selectedOptions && this.selectedOptions[0];
            if (!opt) return renderDescription(null);
            const d = {
              commonName: opt.getAttribute("data-common"),
              sciName: opt.getAttribute("data-sci"),
              description: opt.getAttribute("data-desc")
            };
            renderDescription(d);
          });

          // Restore saved species selection
          SharedState.restoreSpeciesSelection($specie);

          // Auto-load previous prediction if available
          if (SharedState.hasPredictionData()) {
            console.log('Previous prediction data found, auto-loading risk scores...');
            setTimeout(() => loadRiskScores(), 500);
          }
        },
        error: function (err) {
          console.error("Papa error:", err);
          showError("Failed to load CSV. Using fallback data.");
          hydrateWithFallback();
        }
      });

      // Database here

      function loadRiskScores() {
        const tbody = document.getElementById("risk-score-table-body");
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center text-muted py-3">
              <div class="spinner-border text-primary me-2" role="status"></div>
              Fetching data from database...
            </td>
          </tr>
        `;

        // Get selected species scientific name (ensure CSV populates data-sci)
        const specieSelect = document.getElementById('specie');
        const selectedOption = specieSelect.selectedOptions && specieSelect.selectedOptions[0];
        const speciesName = selectedOption ? selectedOption.getAttribute('data-sci') : '';

        const payload = {
          species: speciesName,
          temperature: parseFloat(document.getElementById('temperature').value),
          ph: parseFloat(document.getElementById('water_ph').value),
          salinity: parseFloat(document.getElementById('salinity').value),
          dissolved_oxygen: parseFloat(document.getElementById('dissolved_oxygen').value),
          bod: parseFloat(document.getElementById('bod').value),
          turbidity: parseFloat(document.getElementById('turbidity').value),
          model_choice: document.getElementById('model_choice') ? document.getElementById('model_choice').value : 'xgooa'
        };

        fetch('http://localhost:5000/api/risk-scores', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
          .then(async response => {
            if (!response.ok) {
              const txt = await response.text();
              throw new Error(`HTTP error! status: ${response.status} ${txt}`);
            }
            return response.json();
          })
          .then(data => {
            if (!data.success || !Array.isArray(data.data) || !data.data.length) {
              tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3"><em>No data found in database.</em></td></tr>`;
              return;
            }
            tbody.innerHTML = data.data.map(row => `
            <tr>
              <td>${row.lake || '-'}</td>
              <td>${row.region || '-'}</td>
              <td>${typeof row.score === 'number' ? row.score.toFixed(2) : (row.score || '-')}</td>
              <td>${row.presence === 'Yes' ? 'Yes' : row.presence === 'No' ? 'No' : (row.presence || '?')}</td>
            </tr>
          `).join('');
          })
          .catch(err => {
            console.error("Database fetch error:", err);
            tbody.innerHTML = `
            <tr><td colspan="4" class="text-center text-danger py-3">
              Failed to load data from database.
            </td></tr>
          `;
          });
      }

      function getRiskBadgeColor(riskLevel) {
        switch (riskLevel) {
          case 'High': return 'danger';
          case 'Medium': return 'warning';
          case 'Low': return 'success';
          default: return 'secondary';
        }
      }

      fetch('http://localhost:5000/api/check-presence?species=Anabas testudineus')
        .then(res => res.json())
        .then(data => {
          // Display presence data in your HTML
          console.log(data);
        });

      // Show initial message
      const tbody = document.getElementById("risk-score-table-body");
      tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">Select a species and click "Run Prediction" to see risk scores.</td></tr>`;
    });


  </script>
</body>

</html>